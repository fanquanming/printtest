<!DOCTYPE html>
<!-- saved from url=(0122)https://www.erp321.com/app/print/print/Printer.aspx?preview=true&setter=true&type=express&sub_type=SF.COLLECT&pt_id=571895 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8"><title>
	通用打印
</title></head>

<body style="background-color: #CCCCCC">
    <form method="post" action="https://www.erp321.com/app/print/print/Printer.aspx?preview=true&amp;setter=true&amp;type=express&amp;sub_type=SF.COLLECT&amp;pt_id=571895" id="printForm" onsubmit="return false;" style="width:100%;height:100%">
<div class="aspNetHidden">
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTE3NDUxMjIwNjNkZIJbOTF4OA6ECgmSOzWDYXoPGJap">
</div>

<script language="javascript" id="_request_owner_co_id" type="text/javascript">var ___RequestOwnerCoid=0;</script><script language="javascript" id="_request_authorize_co_id" type="text/javascript">var ___RequestAuthorizeCoid=0;</script><script language="javascript" id="Hxj_Web_UI_Script_jquery-1_8_0_js" type="text/javascript" src="./通用打印_files/WebResource.axd"></script><script language="javascript" id="Hxj_Web_UI_Script_jquery_json-2_4_js" type="text/javascript" src="./通用打印_files/WebResource(1).axd"></script><link id="Hxj_Web_UI_Css_jquery_css" href="./通用打印_files/WebResource(2).axd" rel="stylesheet" type="text/css"><script language="javascript" id="Hxj_Web_UI_Script_hxj-jquery-1_0_0_js" type="text/javascript" src="./通用打印_files/WebResource(3).axd"></script><link id="wulong.iconfont" href="./通用打印_files/font_816790_nxi2aehu5gi.css" rel="stylesheet" type="text/css"><script language="javascript" id="Hxj.Web.UI.ACall_CallPage" type="text/javascript">var _Call_PostForm={};function _CallPage(method,oArgs){var oPostArg=oArgs;if(arguments.length>2){var oPostArg=new Array();for(var iAa1=1;iAa1<arguments.length;iAa1++){if(arguments[iAa1]==null){oPostArg.push(null);}else{oPostArg.push(arguments[iAa1].toString());}}};return $.call('ACall1',oPostArg,method,'{page}',null,true)}</script><script language="javascript" id="Hxj.Web.UI.ACall_AsyncCallPage" type="text/javascript">function _AsyncCallPage(method,callBack,showWait,oArgs){var oPostArg=oArgs;if(arguments.length>4){var oPostArg=new Array();for(var iAa1=3;iAa1<arguments.length;iAa1++){if(arguments[iAa1]==null){oPostArg.push(null);}else{oPostArg.push(arguments[iAa1].toString());}}};return $.call('ACall1',oPostArg,method,'{page}',callBack,showWait)}; function _ACP(method,callBack,oArgs){var oPostArg=oArgs;if(arguments.length>2){var oPostArg=new Array();for(var iAa1=2;iAa1<arguments.length;iAa1++){if(arguments[iAa1]==null){oPostArg.push(null);}else{oPostArg.push(arguments[iAa1].toString());}}};return $.call('ACall1',oPostArg,method,'{page}',callBack,true)}</script>
<div class="aspNetHidden">

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="D4166413">
</div>
        
<link href="./通用打印_files/Prompt.css" rel="stylesheet">
<script src="./通用打印_files/Prompt.js.下载" type="text/javascript"></script>

<table cellpadding="0" cellspacing="0" onclick="document.all.prompt_value.focus()" id="prompt_top" style="display: none;">
    <tbody><tr>
        <td style="vertical-align: top;">

            <div class="_opacity"></div>
            <table cellpadding="0" cellspacing="0" id="prompt_table">
                <tbody><tr>
                    <td style="vertical-align: middle;">
                        <center>
                             <div id="prompt_body" class="main_border _float_box">
                                 <div class="t_" id="prompt_title">提示...</div>
                               <div style="min-height:140px; ">
                                  <div style="padding:12px;">
                                     
                                    <div id="prompt_text"></div>
                                
                                     <input type="text" id="prompt_value" value="" class="input_text" style="width:100%;height:26px;">
                                      
                                 </div>

                                 </div>

                                <div id="prompt_btn_div">
                                    <span id="prompt_confirm" class="btn_1 h28">
                                    确认</span>
                                    <span id="prompt_close" class="btn_4 h28">
                                    取消</span></div>
                            </div>


           
                                  </center>
                    </td>
                </tr>
            </tbody></table>



        </td>
    </tr>
</tbody></table>
<table cellpadding="0" cellspacing="0" onclick="document.all.prompt_value.focus()" id="xprompt_top" style="display: none;">
    <tbody><tr>
        <td style="vertical-align: top;">

            <div class="_opacity"></div>
            <table cellpadding="0" cellspacing="0" id="xprompt_table">
                <tbody><tr>
                    <td style="vertical-align: middle;">
                        <center>
                             <div id="xprompt_body" class="main_border _float_box">
                                 <div class="t_" id="xprompt_title">提示...</div>
                               <div style="min-height:140px; ">
                                  <div style="padding:12px;">
                                     
                                    <div id="xprompt_text" style="word-wrap: break-word;word-break: normal;"></div>
                                
                                     <textarea rows="5" cols="10" id="xprompt_value" class="input_text" style="width:100%;height:100px;overflow:auto;"></textarea>
                                      
                                 </div>

                                 </div>

                                <div id="xprompt_btn_div">
                                    <span id="xprompt_confirm" class="btn_1 h28">
                                    确认</span>
                                    <span id="xprompt_close" class="btn_4 h28">
                                    取消</span></div>
                            </div>
                                  </center>
                    </td>
                </tr>
            </tbody></table>

        </td>
    </tr>
</tbody></table>
<table cellpadding="0" cellspacing="0" onclick="document.all.prompt_value.focus()" id="sprompt_top" style="display: none;">
    <tbody><tr>
        <td style="vertical-align: top;">

            <div class="_opacity"></div>
            <table cellpadding="0" cellspacing="0" id="sprompt_table">
                <tbody><tr>
                    <td style="vertical-align: middle;">
                        <center>
                             <div id="sprompt_body" class="main_border _float_box">
                                 <div class="t_" id="sprompt_title">提示...</div>
                               <div style="min-height:140px; "> 
                                    <div id="sprompt_text"></div> 
                                 </div> 
                                <div id="sprompt_btn_div">
                                    <span id="sprompt_confirm" class="btn_1 h28">
                                    确认</span>
                                    <span id="sprompt_close" class="btn_4 h28">
                                    取消</span></div>
                            </div>
                                  </center>
                    </td>
                </tr>
            </tbody></table>

        </td>
    </tr>
</tbody></table>

        
        
<link href="./通用打印_files/float.css" rel="stylesheet">
<script src="./通用打印_files/float.js.下载" type="text/javascript"></script>
  <table cellpadding="0" cellspacing="0" id="float_top" style="display:none;">
    <tbody><tr>
        <td style="padding-bottom:0px;vertical-align:middle;">
            <center>
                <table cellpadding="0" cellspacing="0" id="float_table">
                    <tbody><tr>
                        <td style="vertical-align:top;">
                         

                            <iframe id="float_frame" name="float_frame" frameborder="0" class="_float_box" src="./通用打印_files/saved_resource.html"></iframe>
                            <div class="_opacity"> </div>
                        </td>
                    </tr>
                </tbody></table>

            </center>
        </td>
    </tr>
</tbody></table>
        
<link href="./通用打印_files/msg.css" rel="stylesheet">
<script src="./通用打印_files/msg.js.下载" type="text/javascript"></script>
<table cellpadding="0" cellspacing="0" id="msg_top" style="display: none;">
    <tbody><tr>
        <td style="vertical-align:top;">

            <div class="_opacity"></div>

            <table cellpadding="0" cellspacing="0" id="msg_table">
                <tbody><tr>
                    <td style="vertical-align: middle;padding-bottom: 10%;">
                        <center style="padding-bottom:10px;">
                            <div id="msg_body" class="main_border _float_box" style="text-align: left; width: 452px;">
                                <div class="t_" id="msg_title">提示 !</div>
                                <div id="msg_text" style="max-height: 820px;">提示：请选择有效的打印机。</div>
                                <div id="msg_btn_div">
                                    <a href="javascript:void(0)" onclick="_MsgHide()" id="msg_close" style="border:none;" class="btn_1 h28">关闭</a>
                                </div>
                            </div>
                        </center>

                        
                    </td>
                </tr>
            </tbody></table>



        </td>
    </tr>
</tbody></table>

        
<link href="./通用打印_files/confirm.css" rel="stylesheet">
<script src="./通用打印_files/confirm.js.下载" type="text/javascript"></script>
<table cellpadding="0" cellspacing="0" id="confirm_top" style="display: none;">
    <tbody><tr>
        <td style="vertical-align: top;">

            <div class="_opacity"></div>
            <table cellpadding="0" cellspacing="0" id="confirm_table">
                <tbody><tr>
                    <td style="vertical-align: middle;">
                        <center>
                            <div id="confirm_body" class="main_border _float_box">
                                <div class="t_" id="confirm_title">请确认 ? </div>

                                

                                    <div id="confirm_text"></div>

                             

                                <div id="confirm_btn_div">
                          
                                    <input type="button" id="confirm_confirm" class="btn_1 h28" tabindex="0" value="确认">
                                    <input type="button" id="confirm_close" class="btn_4 h28" tabindex="1" value="取消">
                                </div>
                            </div>
                        </center>

                        
                    </td>
                </tr>
            </tbody></table>



        </td>
    </tr>
</tbody></table>

        

<script src="./通用打印_files/jstWebSocket-3.0.js.下载"></script>
<script src="./通用打印_files/cnpWebSocket-v2.0.0.js.下载"></script>
<script src="./通用打印_files/pddWebSocket-v1.0.js.下载"></script>
<script src="./通用打印_files/cs-core.js.下载" type="text/javascript"></script>
<script src="./通用打印_files/data.js.下载"></script>
<script src="./通用打印_files/CnpReviewQueue.js.下载"></script>
<script src="./通用打印_files/imageTool.js.下载"></script>
<script src="./通用打印_files/common.js.下载"></script>
<script>window.top.webSocketProtocol = 'wss'; window.top.jstPrinterReady = false; window.top.jstPrinterDebug = false;</script><script src="https://localhost:54323/?v=637258441336177958"></script><script>window.top.isUsePrintHelper=true;var __js_path=["https://www.erp321.com/script/print-0.0.1.js?v=0.4"]</script>

<link href="./通用打印_files/base.css" rel="stylesheet">
<style>
    .sel_size {
        height: 32px;
        font-size: 14px;
        width: 200px;
    }

    .lbl_size {
        height: 32px;
        font-size: 14px;
    }

    .notice {
        background-color: #f7efd0;
        padding: 0px;
        padding-left: 12px;
        padding-right: 12px;
        color: #960014;
        height: 20px;
        font-size: 14px;
        vertical-align: middle;
    }

    .middle {
        vertical-align: middle;
    }

    #printTool {
        position: fixed;
        background-color: #F3F3F3;
        z-index: 999;
        top: 0px;
        left: 0px;
        width: 100%;
        line-height: 32px;
        padding: 3px 2px 4px 2px;
        margin-bottom: 2px;
        border-bottom: 2px solid gray;
        text-align: right;
    }

    .copies {
        width: 40px;
        text-align: center;
        border: 1px solid #bbb;
        background-color: #fff;
        padding: 2px;
        margin: 1px;
    }
</style>
<div style="width: 100%; height: 100%">

    <div id="printTool" class="middle">
        
        <span id="curPrinter" class="lbl_size middle" style="float: left">*</span>
        <span class="lbl_size middle">文档数：</span><span class="lbl_size middle" id="document_count"></span>
        <label class="notice" style="margin-right: 10px; margin-left: 10px; vertical-align: middle;">预览模式只支持预览一页</label>
        
        <label id="lbl_showBorder" class="lbl_size middle" style="vertical-align: middle;">
            <input type="checkbox" id="showBorder" style="zoom: 150%; vertical-align: middle;" name="showBorder">边框
        </label>
        <span id="p_pulgin" class="lbl_size middle" style="background-color: yellow"></span>
        
        <div id="div_printer" style="display: inline-block">
            <span id="page_design" class="lbl_size middle" style="margin-left: 5px;">打印机:</span>
            <select id="printer" class="sel_size middle" name="printer" style="color: blue;"><option value="*">-- 选择打印机 --</option><option value="Fax">Fax</option><option value="发送至 OneNote 2010">发送至 OneNote 2010</option><option value="HP LaserJet Pro MFP M126nw[246417]">HP LaserJet Pro MFP M126nw[246417]</option><option value="Microsoft XPS Document Writer">Microsoft XPS Document Writer</option><option value="Send To OneNote">Send To OneNote</option><option value="OneNote for Windows 10">OneNote for Windows 10</option><option value="HP LaserJet Pro For IT&amp;IMC Dept">HP LaserJet Pro For IT&amp;IMC Dept</option><option value="TASKalfa 2011">TASKalfa 2011</option><option value="NPI3C9A29 (HP LaserJet Professional M1213nf MFP)">NPI3C9A29 (HP LaserJet Professional M1213nf MFP)</option><option value="HP LaserJet 200 color M251n (D975C4)">HP LaserJet 200 color M251n (D975C4)</option><option value="Microsoft Print to PDF">Microsoft Print to PDF</option></select>
        </div>
        <div id="div_template" style="display: inline-block;">
            <span id="lbl_template" class="lbl_size middle" style="margin-left: 5px;">模板:</span>
            <select id="templateURL" class="sel_size middle" name="templateURL" style="color: blue;"><option value="URL-571895-200523151742410|1|0.0|false" _type="express" selected="selected">模板：顺丰速运到付</option><option value="URL-571694-200523140145047|1|0.0|false" _type="express">模板：顺丰JITX电子面单</option></select>
        </div>
        <span id="openSetting" class="btn_line big middle" style="margin-left: 3px;" title="编辑打印模板">编辑</span>
        <label id="lbl_copies" class="lbl_size middle">
            <input type="text" id="copies" class="lbl_size copies" name="copies" onfocus="this.select()" value="1" maxlength="4">(份)
        </label>
        <span id="fastPrint" class="btn_1 big middle" style="margin-left: 5px;">打印</span>
        <span id="fastPreview" class="btn_line big middle" style="margin-left: 5px;">预览</span>
        <span id="fastPreview-all" class="btn_line big middle" style="margin-left: 5px;">预览(全部)</span>
        
        <span id="btPrint" class="btn_line big middle" style="margin-left: 5px;">BT打印</span>

        <input type="hidden" id="page_type" name="page_type" value="*">
        <input type="hidden" id="page_direction" name="page_direction" value="1">
        <input type="hidden" id="debugger" name="debugger" value="">
        <input type="hidden" id="print_type" name="print_type" value="CNP">
        <input type="hidden" id="preview" name="preview" value="">
        <input type="hidden" id="previewType" name="previewType" value="">
        <input type="hidden" id="pt_id" name="pt_id" value="571895">
        <input type="hidden" id="printers" name="printers" value="Fax,发送至 OneNote 2010,HP LaserJet Pro MFP M126nw[246417],Microsoft XPS Document Writer,Send To OneNote,OneNote for Windows 10,HP LaserJet Pro For IT&amp;IMC Dept,TASKalfa 2011,NPI3C9A29 (HP LaserJet Professional M1213nf MFP),HP LaserJet 200 color M251n (D975C4),Microsoft Print to PDF">
        <input type="hidden" id="sample_data" name="sample_data" value="">
        <input type="hidden" id="preview_all" name="preview_all" value="false">
    </div>
    <div style="width: 100%; height: 100%;">
        <div style="width: 100%; height: 100%; padding-top: 44px;" id="preview_image"></div>
    </div>

    <script>
        
        var __SUPPORTS = ["CNP@","CCP@","ORD@","OOD@","PUR@","PPR@","PDA@","JST@"];
        var __IsOnePrinterII = false;
        var __IsShowPrintErrorMsg = false;
        var __FH_1CheckPrint = false;

        var printHandle = {
            maxTryCount: 60,
            printForm:{"_NeedRotate":null,"ExtractMode":2,"Debugger":false,"Async":false,"IsTimeout":false,"WashKind":2,"IsIgnoreZ":false,"ProSupplierId":0,"IsUseCnp":false,"IsUsePdd":true,"IsAdmin":false,"IsProxy":false,"Proxy":null,"OneMode":false,"Type":"express","ShowBorder":false,"SubType":"SF.COLLECT","Printers":null,"templateURL":"URL-571895-200523151742410|1|0.0|false","PtId":571895,"printer":null,"Copies":1,"preview":true,"PrintCount":1,"previewType":"PDF","notifyMode":"allInOne","CanvasNum":1,"NeedRotate":false,"Gap":0,"PrintType":1,"PrintTypeText":"CNP","Others":{"preview":"true","setter":"true","type":"express","sub_type":"SF.COLLECT","pt_id":"571895"},"CompanyId":10547143,"Uid":11486382,"UserCoid":10547143,"CoidNotUserCoid":false,"Template":{"PtId":571895,"pt_id":571895,"modified":"2020-05-23 15:17:42","Html":"\u003cdiv class=\"page\" style=\"width: 23cm; height: 12.7cm;\"\u003e\n                            \u003cdiv class=\"data _fshop_name dataitem\" style=\"left: 115px; top: 144px; cursor: default; width: 70px; height: 22px;\"\u003e{店铺名称}\u003c/div\u003e\u003cdiv class=\"data _freceiver_full_address dataitem\" style=\"left: 99px; top: 296px; width: 261px; height: 77px; cursor: default;\"\u003e{收货省市区+详细地址}\u003c/div\u003e\u003cdiv class=\"data _freceiver_name dataitem\" style=\"left: 288px; top: 269px; cursor: default; width: 82px; height: 22px;\"\u003e{收货人姓名}\u003c/div\u003e\u003cdiv class=\"data _freceiver_mobile_phone dataitem\" style=\"left: 193px; top: 378px; width: 167px; height: 24px; cursor: default;\"\u003e{电话+手机}\u003c/div\u003e\u003cdiv class=\"data _fsend_full_address dataitem\" style=\"left: 103px; top: 175px; width: 251px; height: 51px; cursor: default;\"\u003e{发货省市区+详细地址}\u003c/div\u003e\u003cdiv class=\"data _fsend_city dataitem\" style=\"left: 560px; top: 77px; cursor: default; width: 70px; height: 22px;\"\u003e{发货城市}\u003c/div\u003e\u003cdiv class=\"data _freceiver_city dataitem\" style=\"left: 628px; top: 77px; cursor: default; width: 70px; height: 22px;\"\u003e{收货城市}\u003c/div\u003e\u003cdiv class=\"data _findex dataitem\" style=\"left: 569px; top: 18px; cursor: default; width: 46px; height: 22px;\"\u003e{序号}\u003c/div\u003e\u003cdiv class=\"data _fitem_pattern dataitem\" style=\"left: 395px; top: 181px; width: 242px; height: 52px; font-size: 32px; cursor: default; text-align: center;\"\u003e{自定义商品格式}\u003c/div\u003e\u003cdiv class=\"data _findex dataitem\" style=\"width: 46px; height: 22px;\"\u003e{序号}\u003c/div\u003e\u003cdiv class=\"data _findex dataitem\" style=\"cursor: se-resize; left: 688px; top: 182px; width: 46px; height: 22px;\"\u003e{序号}\u003c/div\u003e\u003cdiv class=\"data _freceiver_city dataitem\" style=\"cursor: default; left: 420px; top: 292px; width: 70px; height: 22px;\"\u003e{收货城市}\u003c/div\u003e\u003cdiv class=\"data _fitem_pattern dataitem\" style=\"cursor: default; left: 427px; top: 335px; width: 106px; height: 22px;\"\u003e{自定义商品格式}\u003c/div\u003e\u003c/div\u003e","Page":"{\"printer\":\"*\",\"page_type\":null,\"page_direction\":\"1\",\"page_speed\":null,\"header_page_height\":\"\",\"page_width\":\"23\",\"page_height\":\"12.7\",\"footer_page_height\":\"\",\"page_padding_left\":null,\"page_padding_top\":null,\"page_padding_right\":null,\"page_padding_bottom\":null,\"page_logo\":null,\"size_top\":null,\"size_left\":null,\"size_width\":null,\"size_height\":null,\"show_bg\":true,\"cross_table\":null,\"print_split_combine\":\"true\",\"print_group_sku\":\"false\",\"table_sku_type\":null,\"table_sku_sort\":null,\"sku_print_type\":null,\"canvas\":1,\"gap\":\"0.0\"}","templateURL":"URL-571895-200523151742410|1|0.0|false","CoId":10547143,"IsDefault":false,"IsSys":false,"IsUserDefault":false,"Name":"顺丰速运到付","Type":"express","SubType":"SF.COLLECT"},"TemplateList":[{"PtId":571895,"pt_id":571895,"modified":"2020-05-23 15:17:42","Page":"{\"printer\":\"*\",\"page_type\":null,\"page_direction\":\"1\",\"page_speed\":null,\"header_page_height\":\"\",\"page_width\":\"23\",\"page_height\":\"12.7\",\"footer_page_height\":\"\",\"page_padding_left\":null,\"page_padding_top\":null,\"page_padding_right\":null,\"page_padding_bottom\":null,\"page_logo\":null,\"size_top\":null,\"size_left\":null,\"size_width\":null,\"size_height\":null,\"show_bg\":true,\"cross_table\":null,\"print_split_combine\":\"true\",\"print_group_sku\":\"false\",\"table_sku_type\":null,\"table_sku_sort\":null,\"sku_print_type\":null,\"canvas\":1,\"gap\":\"0.0\"}","templateURL":"URL-571895-200523151742410|1|0.0|false","CoId":10547143,"IsDefault":false,"IsSys":false,"IsUserDefault":false,"Name":"顺丰速运到付","Type":"express","SubType":"SF.COLLECT"},{"PtId":571694,"pt_id":571694,"modified":"2020-05-23 14:01:45","Page":"{\"printer\":\"*\",\"page_type\":null,\"page_direction\":\"1\",\"page_speed\":null,\"header_page_height\":\"\",\"page_width\":\"10\",\"page_height\":\"10\",\"footer_page_height\":\"\",\"page_padding_left\":null,\"page_padding_top\":null,\"page_padding_right\":null,\"page_padding_bottom\":null,\"page_logo\":null,\"size_top\":null,\"size_left\":null,\"size_width\":null,\"size_height\":null,\"show_bg\":false,\"cross_table\":null,\"print_split_combine\":\"true\",\"print_group_sku\":\"false\",\"table_sku_type\":null,\"table_sku_sort\":null,\"sku_print_type\":null,\"canvas\":1,\"gap\":\"0.0\"}","templateURL":"URL-571694-200523140145047|1|0.0|false","CoId":10547143,"IsDefault":false,"IsSys":false,"IsUserDefault":false,"Name":"顺丰JITX电子面单","Type":"express","SubType":"SF.COLLECT"}],"setter":true,"SortMode":1,"isWriteDebuggerLog":false},
            isCnpPrintTestUser:true,
            isPddPrintUser:true,
            ws: 'https:' == document.location.protocol ? "wss" : "ws",
            jstPort: 'https:' == document.location.protocol ? 54323 : 54322,
            onePrinted: false,//第一次打印
            isFastPrinting: 0,
            isFastPrintTimeout: false,
            fastPrintTimeoutMsg: '提示：打印页面超时(10分钟)，请关闭后重新打开。',
            jstClientDebug: false,//erp助手调试模式

            JST_CLIENT: null,
            CNP_CLIENT: null,
            PDD_CLIENT: null,

            PdfReviewAsyncQueue: new CnpReviewQueue(),


            Init: function () {

                var self = this;

                self.printForm.CurrentTemplate = self.printForm.Template;

                if (window.top.jstPrinterDebug != undefined && window.top.jstPrinterDebug) {
                    self.jstClientDebug = true;
                    self.printForm.Debugger = true;
                }

                if (self.printForm.TemplateList && self.printForm.TemplateList.length > 0) {
                    self.InitTemplate(self.printForm.TemplateList);
                }

                if (self.printForm.IsTimeout) {
                    window.setTimeout(function () {
                        self.isFastPrintTimeout = true;
                    }, 600000);
                }

                self.Init_JSTClient();
                self.Init_CNPClient();
                if (self.isPddPrintUser) {
                    self.Init_PDDClient();
                }
                self.InitEvent();

            },
            InitEvent: function () {
                var self = this;

                $('#fastPreview').click(function () {
                    $("#preview_all").val(false);
                    self.Print(true, "CNP");
                });

                $('#fastPreview-all').click(function () {
                    $("#preview_all").val(true);
                    self.Print(true, "CNP");
                });

                $('#fastPrint').click(function () {

                    $("#preview_all").val(false);
                    if (self.printForm.OneMode && self.onePrinted) {
                        $.cfm("不允许重复打印，请关闭本页后重新打开`点击【确定】关闭页面，【取消】停留在当前页", function (isOK) {
                            if (isOK) {
                                window.close();
                            }
                        });

                        return;
                    };

                    if (self.printForm.OneMode && !self.onePrinted) {
                        self.onePrinted = true;
                    }

                    self.Print(false, "CNP");
                });

                $("#btPrint").click(function () {
                    self.Print(false, "BT");
                });

                //$('#slowPrint').click(function () {
                //    if (__isFastPrintTimeout) {
                //        $.msg(__fastPrintTimeoutMsg);
                //        return false;
                //    }

                //    $(__pageClientId).hide();
                //    window.print();
                //});

                if (self.printForm.CoidIsNotUserCoid) {
                    $('#openSetting').hide();
                }
                else {
                    //编辑按钮
                    $('#openSetting').click(function () {

                        var templateURL = $("#templateURL").val();

                        for (var i = 0; i < self.printForm.TemplateList.length; i++) {
                            if (self.printForm.TemplateList[i].templateURL == templateURL) {
                                self.printForm.CurrentTemplate = self.printForm.TemplateList[i];
                                break;
                            }
                        }

                        var openURL = "/app/print/setter/new.aspx?____ver=2.0&type=" + self.printForm.CurrentTemplate.Type + "&sub_type=" + self.printForm.CurrentTemplate.SubType + "&mode=online&reload=__loadPage";

                        if (self.printForm.CurrentTemplate) {
                            openURL += "&pt_id=" + self.printForm.CurrentTemplate.PtId;
                        }

                        window.open(openURL);

                    });
                }

                if (self.printForm.preview) {

                    self.Preview(0);
                };

                // 关闭前，检测任务队列是否还有没有发送的任务
                $(window).on('beforeunload', function () {
                    if (self.CNP_CLIENT.msgQueue.length > 0) {
                        return "打印任务没有发送完成，关闭页面可能导致打印缺失";
                    }
                    if (self.isPddPrintUser && self.PDD_CLIENT.msgQueue.length > 0) {
                        return "打印任务没有发送完成，关闭页面可能导致打印缺失";
                    }
                });

                $(window).resize(function () {
                    self.setTopPos();
                });
            },
            InitTemplate: function (tems) {
                try {
                    var self = this;
                    var templateURL = $("#templateURL");
                    for (var i = 0; i < tems.length; i++) {
                        var item = tems[i];
                        var text = (item["IsSys"] ? '模板(系统)：' : '模板：') + item["Name"];
                        if (item["Type"] == "cnp") {
                            text += ' [菜鸟]';
                        }
                        else if (item["Type"] == "pdd") {
                            text += ' [拼多多]';
                        }
                        var option = $('<option></option>').attr("value", item["templateURL"])
                            .attr('_type', item['Type']).text(text)
                            .appendTo(templateURL);

                        if (item.PtId == self.printForm.CurrentTemplate.PtId) {
                            option.attr("selected", "selected");

                        }
                    }

                    $("#templateURL").change(function () {

                        for (var i = 0; i < tems.length; i++) {
                            if (tems[i].templateURL == $("#templateURL").val()) {
                                $("#pt_id").val(tems[i].PtId);
                                self.printForm.CurrentTemplate = tems[i];
                                var pageSetting = $.parseJSON(self.printForm.CurrentTemplate.Page)
                                if (window.top.__LocalPrinters && window.top.__LocalPrinters.contains(pageSetting.printer)) {
                                    $("#curPrinter").text(pageSetting.printer);
                                    $("#printer").val(pageSetting.printer);
                                }

                                $("#fastPreview").click();
                                self.setTopPos();
                            }
                        }
                    });
                }
                catch (ex) {
                    self.WriteLog(ex);
                }
            },
            Init_JSTClient: function () {
                var self = this;
                if (window.top.JST && window.top.JST.ready) {
                    self.JST_CLIENT = window.top.JST;
                    return;
                }

                self.JST_CLIENT = new JstWebSocket(self.ws, self.jstPort);
                self.JST_CLIENT.load();

                self.JST_CLIENT.onLoaded = function (jc) {
                    window.top.JST = null;
                    window.top.JST = jc;

                    if (jc.ready) {
                        console.log("Jst.jstClient: ready");
                    }

                    if (jc.jpsTimer > 0) {
                        window.clearInterval(jc.jpsTimer);
                    }
                }

                self.JST_CLIENT.onClosed = function (jc) {
                    console.log("Jst.jstClient: closed");

                    if (jc.jpsTimer > 0) {
                        return;
                    }

                    jc.jpsTimer = window.setInterval(function (ws) {
                        ws.load();
                    }, 3000, jc);
                };
            },
            Init_CNPClient: function () {

                var self = this;

                if (window.top.CNP_CLIENT && window.top.CNP_CLIENT.ready) {
                    self.CNP_CLIENT = window.top.CNP_CLIENT;
                    self.LoadPrinter(0);
                    return;
                }

                console.log("CNP_CLIENT = new CnpWebSocket")

                self.CNP_CLIENT = new CnpWebSocket(self.ws);
                self.CNP_CLIENT.load();

                self.CNP_CLIENT.onLoaded = function (cc) {
                    self.LoadPrinter(0);
                }

                self.CNP_CLIENT.onReceived = function (response) {
                    LOGGER.message(response);
                };

                self.CNP_CLIENT.onSended = function (request) {
                    LOGGER.send(request);
                }
            },
            Init_PDDClient: function () {

                var self = this;

                if (window.top.PDD_CLIENT && window.top.PDD_CLIENT.ready) {
                    self.PDD_CLIENT = window.top.PDD_CLIENT;
                    return;
                }

                console.log("PDD_CLIENT = new PddWebSocket");

                self.PDD_CLIENT = new PddWebSocket(self.ws);

                self.PDD_CLIENT.load();

                self.PDD_CLIENT.onLoaded = function (cc) {

                }

                self.PDD_CLIENT.onReceived = function (response) {
                    PDD_LOGGER.message(response);
                };

                self.PDD_CLIENT.onSended = function (request) {
                    PDD_LOGGER.send(request);
                }
            },
            LoadPrinter: function (tryCount) {

                var self = this;

                if (!self.CNP_CLIENT.ready) {
                    if (tryCount > self.maxTryCount) {
                        self.WriteLog(LOGGER.resources.cnpConnectFailed);
                        return;
                    }

                    if (tryCount == undefined) {
                        tryCount = 0;
                    }

                    setTimeout(self.LoadPrinter, 50, ++tryCount);
                    self.WriteLog("__loadPrinter:" + tryCount);
                    return;
                }

                var request = {
                    requestID: $.ts().toString(),
                    version: "1.0",
                    cmd: "getPrinters"
                };

                self.CNP_CLIENT.send(request, self.GetPrintersCallBack);
            },
            Preview: function (tryCount) {
                var self = printHandle;

                if (!self.CNP_CLIENT.ready || !window.top.__LocalPrinters) {

                    if (tryCount > self.maxTryCount) {
                        $.msg(LOGGER.resources.cnpConnectFailed);
                        return;
                    }

                    setTimeout(self.Preview, 50, ++tryCount);
                    return;
                }

                self.Print(true, "CNP");
            },
            Print: function (preview, printType) {

                var self = this;

                if (!self.CheckPrinter()) {
                    return;
                }

                if (preview == null  || typeof (preview) == "undefined") {
                    preview = "";
                }

                $("#preview").val(preview);

                if (typeof (printType) != "undefined" && printType) {
                    $("#print_type").val(printType);
                }

                if (self.printForm.setter) {
                    //这里是页面数据的来源。不是pdf里面的数据来源

                    $("#sample_data").val(getSampleData(self.printForm.Type, self.printForm.SubType));
                }
                else {
                    $("#sample_data").val("");
                }

                if (self.printForm.IsTimeout && self.isFastPrintTimeout) {
            $.msg(self.fastPrintTimeoutMsg);
            return;
                }

                if (self.isFastPrinting > 0) {
                    return;
                }

                self.isFastPrinting = 1;

                $("#fastPrint").attr("disabled", "disabled");//原来是this，设置disabled无效，意在控制重复点击，放后处理

                var printType = $("#print_type").val();

                self.WriteLog("PRINT_TYPE:" + printType);

                $("#debugger").val(self.jstClientDebug.toString());

                _ACP("GetRequests", function (rv) {

                    if (rv == undefined) {
                        try {
                            var errorR = "rv is undefined";

                            if ($ && $.errorResult) {
                                errorR = $.toJSON($.errorResult);
                            }

                            _ACP("SaveAjaxError", function (rv) { }, errorR);
                        }
                        catch (err) {
                            console.error(err);
                        }
                    }

                    if (rv) {
                        self.isFastPrinting = 0;
                        var datas = $.parseJSON(rv);
                        self.WebSocketSend(0, datas, printType);
                    }
                });

                setTimeout(function () {
                    $("#fastPrint").removeAttr("disabled");
                }, 500);

            },
            /**
             * PDF预览返回值写入集合
             * @param state
             * @param data
             * @param response
             */
            PdfSendReviewCallBack:  function (state, data, response) {
                var self = printHandle;
                if (response.status == "failed") {
                    //一个任务失败，会清空其他任务。检查菜鸟组件
                    self.PdfReviewAsyncQueue.pop().callback();
                    self.PdfReviewAsyncQueue.clear();
                    return;
                }
                self.PdfReviewAsyncQueue.rePacketData(response, self);
            },
            WebSocketCallBack: function (state, data, response) {

                var self = printHandle;

                if (response == null || typeof (response) == "undefined") {
                    return;
                }

                self.WriteLog("WebSocketCallBack");
                self.WriteLog(data);
                self.WriteLog(response);

                if (PRINTER.showPDFTimer > 0) {
                    window.clearTimeout(PRINTER.showPDFTimer);
                    PRINTER.showPDFTimer = 0;
                    PRINTER.hidePreviewPDF();
                }

                if (response.status != "success" && response.status != undefined) {
                    self.WriteLog(response);
                    return;
                }

                self.ShowPreviewResult(response);
            },
            ShowPreviewResult: function (response) {
                var self = this;

                if (response.previewImage || response.previewURL) {
                    $("#preview_image").empty();
                    var appendPreviewImage = $("#preview_image");
                    var pageWidth = "";
                    var pageHeight = "";
                    var canvas = 1;
                    var gap = 0;
                }

                if (self.printForm.CurrentTemplate) {
                    var pageSetting = $.parseJSON(self.printForm.CurrentTemplate.Page);

                    pageWidth = pageSetting.page_width;
                    pageHeight = pageSetting.page_height;
                    if (pageSetting.page_direction == 2) {
                        var tempWith = pageWidth;
                        pageWidth = pageHeight;
                        pageHeight = tempWith;
                    }

                    canvas = pageSetting.canvas;
                    gap = pageSetting.gap;
                }

                if (response.previewImage) {

                    var showWidth = pageWidth;
                    var showHeight = pageHeight;

                    if (pageSetting.page_direction == 1) {
                        showWidth = pageWidth * canvas + (canvas - 1) * gap;
                    }
                    else {
                        showHeight = pageHeight * canvas + (canvas - 1) * gap;
                    }

                    for (var i = 0; i < response.previewImage.length; i++) {

                        var imageURL = response.previewImage[i];

                        appendPreviewImage.append($("<img src=\"" + imageURL + "\" />").css("width", showWidth + "cm")
                            .css("height", showHeight + "cm")
                            .css("margin-left", "5px")
                            .css("margin-top", "3px"));
                    }
                }

                if (response.previewURL) {

                    var imageURL = response.previewURL;

                    appendPreviewImage.append($("<iframe src=\"" + imageURL + "\" width=\"100%\" height=\"100%\" ></iframe>")
                        .css("margin-left", "0px")
                        .css("margin-right", "0px")
                        .css("display", "block")
                        .css("margin-bottom", "0px")
                        .css("margin-top", "0px"));

                }
            },
            /*
             tryCount:重试次数
             jstRequest:打印数据包
             requestMode:打印请求类型，BT,CNP
             callback:回调函数
             ignorePromp:是否忽略提示
             requestMode：调用模式后面需要调整成后台数据判断好的模式，合并在jstRequest中
             ignoreFailed：一点一货验货，增加输入验证码功能，临时参数后面想办法调整
             */
            PdfSendReviewCallBack: function (tryCount, jstRequest, requestMode, callback, ignorePromp, ignoreFailed) {

                var self = this;

                if (!self.CheckReady(tryCount, jstRequest, requestMode, callback, ignorePromp, ignoreFailed)) {
                    return;
                }

                self.WriteLog("WebSocketSend");
                self.WriteLog(jstRequest);

                if (jstRequest.hasOwnProperty("IgnoreRequest") && jstRequest.IgnoreRequest) {
                    callback("IGNORED", null, jstRequest);
                    return;
                }

                var isIgnoreFailed = false;
                if (ignoreFailed != undefined && ignoreFailed) {
                    isIgnoreFailed = true;
                }

                if (jstRequest.status != "success") {
                    if (!isIgnoreFailed) {
                        $.msg(jstRequest.ex);
                    }

                    if (callback != undefined && typeof (callback) == "function") {
                        callback("FAILED", null, jstRequest);
                    }
                    return;
                }

                if (!jstRequest.requestBodys || jstRequest.requestBodys <= 0) {
                    if (!isIgnoreFailed) {
                        $.msg("没有需要打印的数据，请确认");
                    }

                    if (callback != undefined && typeof (callback) == "function") {
                        callback("FAILED", null, jstRequest);
                    }
                    return;
                }

                $("#document_count").html(jstRequest.DocumentCount);
                var igPromp = false;
                if (ignorePromp != undefined && ignorePromp) {
                    igPromp = true;
                }

                if (jstRequest.promp && !igPromp && window.top._Prompt && typeof (window.top._Prompt) == "function") {
                    var signCode = (new Date()).getMinutes().toString();
                    if (signCode.length == 1) {
                        signCode = "0" + signCode;
                    }

                    var rv = _CallPage("SendReprintAuthCode");

                    var prompText = jstRequest.promp;
                    if (rv)//强制验证
                    {
                        prompText = prompText + "`请找有权限之人输入验证码(" + rv + ")";
                    }
                    else {
                        prompText = prompText + "`校验码：" + signCode;
                    }

                    var opt = {};
                    opt.html = prompText;
                    opt.value = "";
                    opt.width = null;
                    opt.closeCallBack = true;
                    opt.callback = function (code) {
                        code = code.replace(/[\r\n]/g, "");
                        if (rv)//强制验证
                        {
                            if (code == "CLOSE")//关闭窗口
                            {
                                if (callback != undefined && typeof (callback) == "function") {
                                    callback("CLOSE", jstRequest, null);
                                }
                                return;
                            }
                            //服务端验证，通过的话，返回输入验证码的主管用户编号
                            var supervisorUid = _CallPage("VerifyReprintAuthCode", code);
                            if (supervisorUid) {
                                self.ToSendCmd(jstRequest, requestMode, callback);
                                self.SaveCnpLogCode("", supervisorUid, jstRequest.promp);
                            }
                            else//验证失败
                            {
                                if (callback != undefined && typeof (callback) == "function") {
                                    callback("CLOSE", jstRequest, null);
                                }
                                $.msg("输入的校验码错误，操作失败");
                            }
                            return;
                        }
                        else {
                            if (code == "__X_CONFIRM__") {
                                self.ToSendCmd(jstRequest, requestMode, callback);
                                self.SaveCnpLogCode("", code, jstRequest.promp);
                            }
                            else if (code != signCode || code == "CLOSE") {
                                if (callback != undefined && typeof (callback) == "function") {
                                    callback("CLOSE", jstRequest, null);
                                }

                                if (code != signCode && code != "CLOSE") {
                                    $.msg("输入的校验码错误，操作失败");
                                }

                                return;
                            }
                            else {
                                // 校验码
                                self.ToSendCmd(jstRequest, requestMode, callback);
                                self.SaveCnpLogCode("", code, jstRequest.promp);
                            }
                        }
                    };

                    window.top._XPrompt(opt);

                    return;
                }

                if (jstRequest.msg) {

                    $.cfm("提示：" + jstRequest.msg + "`取消返回，确认继续执行？", function (isOK) {

                        if (!isOK) {
                            if (callback != undefined && typeof (callback) == "function") {
                                callback("CANCEL", null, jstRequest);
                            }

                            return;
                        }
                        else {
                            self.ToSendCmd(jstRequest, requestMode, callback);
                        }
                    });
                }
                else {
                    self.ToSendCmd(jstRequest, requestMode, callback);
                }
            },
            /*
             判断websocket连接是否就绪
             */
            CheckReady: function (tryCount, jstRequest, requestMode, callback, ignorePromp, ignoreFailed) {

                var self = this;

                var ready = self.IsReady(requestMode);

                if (!ready) {
                    setTimeout(function () {

                        if (tryCount == undefined) {
                            tryCount = 0;
                        }

                        tryCount++;

                        self.WriteLog("WebSocketSend-[needSetTimeout][" + tryCount + "]");

                        if (tryCount > self.maxTryCount) {

                            $.msg(LOGGER.resources.cnpConnectFailed);

                            if (callback != undefined && typeof (callback) == "function") {
                                callback(jstRequest);
                            }

                            return;
                        }

                        self.WebSocketSend(tryCount, jstRequest, requestMode, callback, ignorePromp, ignoreFailed);

                    }, 50);
                }

                return ready;
            },
            ToSendCmd: function (jstRequest, requestMode, callback) {

                var self = this;

                var datas = jstRequest.requestBodys;

                for (var i = 0; i < datas.length; i++) {
                    var request = datas[i];

                    var printType = "*";

                    if (request.hasOwnProperty("PrintType") && request.PrintType) {
                        printType = request.PrintType;
                    }

                    var curClient = null;

                    if (requestMode == "BT" || printType == "pdf") {
                        curClient = self.JST_CLIENT;
                    }
                    else if (request.IsUsePdd) {
                        curClient = self.PDD_CLIENT;
                    }
                    else {
                        curClient = self.CNP_CLIENT;
                    }

                    if (typeof (callback) != "undefined" && typeof (callback) == "function") {
                        curClient.send(request, callback, null);
                        continue;
                    }
                    if (requestMode == "BT" || printType == "pdf") {
                        curClient.send(request, self.WebSocketCallBack, null);
                        continue;
                    }
                    if ($("#preview").val() === "true" && $("#preview_all").val() === "true") {
                        PRINTER.showPreviewPDF();
                        PRINTER.showPDFTimer = window.setTimeout(function () {
                            PRINTER.hidePreviewPDF();
                        }, 30000);
                    }
                    if (requestMode == "PdfSend") {
                        curClient.send(request, self.PdfSendReviewCallBack, null);
                        continue;
                    }

                    curClient.send(request, self.WebSocketCallBack, null);

                    //if (requestMode == "BT" || printType == "pdf") {
                    //    if (typeof (callback) != "undefined" && typeof (callback) == "function") {
                    //        self.JST_CLIENT.send(request, callback, null);
                    //    }
                    //    else {
                    //        self.JST_CLIENT.send(request, self.WebSocketCallBack, null);
                    //    }

                    //}
                    //else {
                    //    if (typeof (callback) != "undefined" && typeof (callback) == "function") {
                    //        self.CNP_CLIENT.send(request, callback, null);
                    //    }
                    //    else {
                    //        if ($("#preview").val() === "true" && $("#preview_all").val() === "true") {
                    //            PRINTER.showPreviewPDF();
                    //            PRINTER.showPDFTimer = window.setTimeout(function () {
                    //                PRINTER.hidePreviewPDF();
                    //            }, 30000);
                    //        }

                    //        self.CNP_CLIENT.send(request, self.WebSocketCallBack, null);
                    //    }
                    //}
                }
            },
            PrintAsync: function (taskId, printForm, callback, ignorePromp, pIsAsync) {

                var self = this;

                printForm.debugger = self.jstClientDebug;

                if (printForm.disablePrinters == undefined || !printForm.disablePrinters) {
                    printForm.printers = $("#printers").val();
                }

                var calcAsync = true;

                if (typeof (pIsAsync) != "undefined" && pIsAsync === false) {
                    calcAsync = false;
                }

                $.ajax("Printer.aspx?async=true", {
                    data: printForm,
                    dataType: 'json',
                    type: 'POST',
                    async: calcAsync,
                    success: function (responseData) {
                        if (typeof (taskId) != "undefined" && taskId && responseData.length == 1) {

                            if (responseData[0].requestBody == null) {
                                console.log(responseData)
                            }
                            else if (responseData[0].requestBody.task != null && responseData[0].requestBody.hasOwnProperty("task")) {
                                responseData[0].requestBody.task.taskID = taskId;
                            }
                        }

                        //self.WriteLog(responseData);

                        var printType = typeof (printForm.print_type) == "undefined" ? "CNP" : printForm.print_type;

                        var isAsync = false;
                        var ViewList = [];
                        if (__IsOnePrinterII) {
                            try {
                                if (responseData.requestBodys != null) {
                                    for (var i = 0; i < responseData.requestBodys.length; i++) {
                                        var cnp_data = responseData.requestBodys[i].cnp_data;
                                        if (typeof (cnp_data) != "undefined" && cnp_data != null && cnp_data != "") {
                                            var data = JSON.parse(cnp_data);
                                            ViewList.push(data.task.taskID);
                                            data.task.printer = PickPrinter();
                                            responseData.requestBodys[i].viewId = data.task.taskID;
                                            self.WebSocketSend(0,
                                                {
                                                    DocumentCount: 1,
                                                    Form: null,
                                                    IgnoreRequest: false,
                                                    auther: "qingfeng",
                                                    requestBodys: [data],
                                                    status: "success"
                                                }, "PdfSend");
                                        }
                                    }
                                }
                                if (ViewList.length > 0) {
                                    self.PdfReviewAsyncQueue.push({
                                        request: responseData,
                                        ViewList: ViewList,
                                        callback: callback
                                    });
                                    isAsync = true;
                                }
                            } catch (e) {
                                console.log(e);
                            }
                        }

                        if (!isAsync) {
                            self.WebSocketSend(0, responseData, printType, callback, ignorePromp);
                        }
                    },
                    error: function (_ajax, _msg, _ex) {
                        try {
                            var errorR = $.toJSON({ "ajax": _ajax, "msg": _msg, "ex": _ex });

                            _ACP("SaveAjaxError", function (rv) { }, errorR);
                        }
                        catch (err) {
                            console.error(err);
                        }

                        $.msg(LOGGER.resources.ajaxPostError);

                        if (callback != undefined && typeof (callback) == "function") {
                            callback(printForm);
                        }
                    }
                });
            },
            CheckPrinter: function () {
                var self = this;

                if (!self.CNP_CLIENT.ready) {
                    $.msg(LOGGER.resources.cnpConnectFailed);
                    return false;
                }

                var printerName = $('#printer').val();

                if (printerName == '*') {
                    $.msg('提示：请选择有效的打印机。');
                    return false;
                }
                return true;
            },
            //LoadPrinter的回调函数
            GetPrintersCallBack: function (state, data, response) {

                var self = printHandle;

                self.WriteLog(response);

                if (response.cmd != "getPrinters") {
                    self.WriteLog("error getPrintersCallBack:" + response.cmd);
                    return;
                }

                //拼多多没有status字段
                //if (response.status != "success") {
                //    $.msg("菜鸟打印控件异常:" + response.msg + " 尝试重启打印助手再试");
                //    return;
                //}

                if (!response.printers || response.printers.length == 0) {
                    $('#p_pulgin').html('<a href="javascript:window.location.reload()">没有可用的打印机，请确认打印机连接是否正确！</a>');
                    return;
                }

                var curPrinter = $("#printer").val();
                var printerList = $("#printer");
                printerList.empty();

                $('<option value="*"></option>').text("-- 选择打印机 --").appendTo(printerList);

                var printers = response.printers;

                var printerArray = [];

                for (var i = 0; i < printers.length; i++) {
                    var p = printers[i];

                    //拼多多不判断
                    //if (!(p.status == "enable")) {
                    //    continue;
                    //}

                    printerArray.push(p.name);

                    $('<option></option>').attr("value", p.name).text(p.name).appendTo(printerList);
                }

                var printerString = printerArray.join(",");

                $("#printers").val(printerString);

                self.WriteLog(printerString);

                if (self.printForm.CurrentTemplate) {
                    var pageSetting = $.parseJSON(self.printForm.CurrentTemplate.Page)

                    var calcPrinter = self.GetNetWorkPrinter(printerArray, pageSetting.printer);
                    $("#printer").val(calcPrinter);
                    $("#curPrinter").text(pageSetting.printer);
                }

                if (curPrinter && curPrinter != "*") {
                    $("#printer").val(curPrinter);
                    $("#curPrinter").text(curPrinter);
                }

                self.setTopPos();

                window.top.__LocalPrinters = printerArray;
            },
            GetNetWorkPrinter: function (printers, tempaltePrinter) {
                if (printers.contains(tempaltePrinter)) {
                    return tempaltePrinter;
                }

                var clearTemlatePrinter = tempaltePrinter;

                if (tempaltePrinter.startsWith("\\\\")) {
                    clearTemlatePrinter = tempaltePrinter.substr(tempaltePrinter.lastIndexOf("\\") + 1);
                }

                for (var i = 0; i < printers.length; i++) {
                    var localPrinter = printers[i];

                    if (localPrinter == clearTemlatePrinter) {
                        return localPrinter;
                    }

                    if (!tempaltePrinter.startsWith("\\\\") && !localPrinter.startsWith("\\\\")) {
                        continue;
                    }


                    if (!localPrinter.startsWith("\\\\")) {
                        continue;
                    }

                    var clearLocalPrinter = localPrinter.substr(localPrinter.lastIndexOf("\\") + 1);

                    if (clearLocalPrinter == clearTemlatePrinter) {
                        return localPrinter;
                    }
                }
            },
            //判断websocker是否已经连接成功
            IsReady: function (requestMode) {
                var self = this;
                if (requestMode == "BT") {
                    if (!window.top.JST.ready) {
                        return false;
                    }
                }
                else {
                    if (!self.CNP_CLIENT.ready) {
                        return false;
                    }
                }

                return true;
            },
            //重设布局
            setTopPos: function () {
                var windowWidth = $(window).outerWidth();
                var settingWidth = $("#lbl_showBorder").outerWidth() + $("#div_printer").outerWidth() + $("#div_template").outerWidth()
                    + $("#openSetting").outerWidth() + $("#lbl_copies").outerWidth() + $("#fastPrint").outerWidth() + $("#fastPreview").outerWidth()
                    + $("#btPrint").outerWidth();
                var printerWidth = $("#curPrinter").outerWidth();

                if (windowWidth - settingWidth - printerWidth < 240) {
                    $(".notice").hide();
                }
                else {
                    $(".notice").show();
                }

                var height = $("#printTool").outerHeight();
                $("#preview_image").css("padding-top", height + "px");
            },
            //保存验证码
            SaveCnpLogCode: function (moudle, code, msg) {
                _ACP("SaveCnpLogCode", function () { }, moudle, code, msg);
            },
            CreateTaskId: function (printKey, withTime) {

                var self = this;

                if ((typeof (printKey) == "undefined" || printKey == null || printKey == "") && self.JST_CLIENT) {
                    return self.JST_CLIENT.guid();
                }

                if (typeof (withTime) != "undefined" && withTime) {
                    var nowTime = new Date();
                    nowTime = nowTime.getFullYear().toString()
                        + (nowTime.getMonth() + 1).toString() + nowTime.getDate().toString() + nowTime.getHours()
                        + nowTime.getMinutes()
                        + nowTime.getSeconds()
                        + nowTime.getMilliseconds();

                    return printKey + "-" + nowTime;
                }

                return printKey;
            },
            //浏览器打印信息
            WriteLog: function (log) {

                var self = this;

                if (!self.printForm.Debugger) {
                    return;
                }

                console.log(log);
            },
        }

        printHandle.Init();

    </script>

    <script title="exports">

        function __loadPage() {
            $.cfm("打印模板已修改，是否重新加载？", function (isOK) {
                if (isOK) {
                    window.location.reload();
                }
            });
        }

        function __GetPrinters() {
            return $("#printers").val();
        };

        function PickPrinter() {
            var printers = __GetPrinters().split(',');
            function sj() { 
                var x = printers.length;
                var y = 0;
                var rand = parseInt(Math.random() * (x - y + 1) + y);
                return rand;
            }

            return printers[sj()-1];

        }

        function PrintAsync(taskId, printForm, callback, ignorePromp, pIsAsync) {
            //debugger
            printHandle.PrintAsync(taskId, printForm, callback, ignorePromp, pIsAsync);
        };

        function CreateTaskId(printKey, withTime) {
            //debugger
            printHandle.CreateTaskId(printKey, withTime);
        }

        function __WebSocketSend(jstRequest, requestMode, callback, ignorePromp, ignoreFailed) {
            //debugger
            printHandle.WebSocketSend(0, jstRequest, requestMode, callback, ignorePromp, ignoreFailed);
        }

        //function ToSendCmd(jstRequest, requestMode, callback) {
        //    printHandle.ToSendCmd(jstRequest, requestMode, callback);
        //}
    </script>

</div>

    </form>


</body></html>